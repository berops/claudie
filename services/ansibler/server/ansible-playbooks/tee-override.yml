- hosts: all
  gather_facts: false
  become: true
  tasks:
    - name: Create a tee binary override 
      copy:
        # In order the script to work, the /usr/local/bin has to be before /usr/bin in PATH
        dest: "/usr/local/bin/tee"
        mode: "0755"
        content: |
          #!/bin/bash

          # Loop over arguments to check if /etc/containerd/config.toml is being written
          for arg in "$@"; do
              if [[ "$arg" == "/etc/containerd/config.toml" ]]; then
                  # If file exists and is non-empty, discard input
                  if [[ -f "/etc/containerd/config.toml" ]] && [[ -s "/etc/containerd/config.toml" ]]; then
                      while read -r line; do
                          : # discard each line
                      done
                      exit 0
                  fi
              fi
          done

          # Otherwise, pass through to the real tee
          exec /usr/bin/tee "$@"
