- hosts: all
  gather_facts: false
  become: true
  tasks:
    - name: Create a tee binary override 
      copy:
        # In order the script to work, the /usr/local/bin has to be before /usr/bin in PATH
        dest: "/usr/local/bin/tee"
        mode: "0755"
        content: |
          #!/bin/bash

          # Loop over arguments to check if we're writing to /etc/containerd/config.toml
          for arg in "$@"; do
              if [[ "$arg" == "/etc/containerd/config.toml" ]]; then
                  # Check if conf.d directory exists and contains nvidia config files
                  if [[ -d "/etc/containerd/conf.d" ]] && compgen -G "/etc/containerd/conf.d/*nvidia*" > /dev/null; then
                      exit 0
                  fi
              fi
          done

          # Otherwise, pass through to the real tee
          exec /usr/bin/tee "$@"
